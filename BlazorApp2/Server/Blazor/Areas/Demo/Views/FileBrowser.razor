@page "/file-browser"
@rendermode InteractiveServer
@inject IFileSystemService FileSystemService
@using BlazorApp2.Server.Services.BuisnessLogic.Implementations
@using BlazorApp2.Server.Services.BuisnessLogic.Interfaces
@using BlazorApp2.SharedCode.Models.Partials
@using MudBlazor

<MudPopoverProvider />
<MudDialogProvider />

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">

    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="@OnExplorerSelectorButtonClick"
                           Class="mb-4"
                           FullWidth="true">
                    <i class="fa-solid fa-folder-open me-2"></i>
                    Open Explorer Selector
                </MudButton>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-2">@errorMessage</MudAlert>
                }

                <MudDialog @bind-Visible="_visibleDialog" Options="_dialogOptions">
                    <TitleContent>
                        <MudText Typo="Typo.h6">File Explorer</MudText>
                    </TitleContent>
                    <DialogContent>
                        <MudGrid Spacing="2">
                            <MudItem xs="12">
                                <MudPaper Class="pa-2 d-flex align-center gap-2" Elevation="0">
                                    <MudIconButton Icon="@("fa-solid fa-arrow-left")"
                                                   Size="Size.Small"
                                                   Color="Color.Default"
                                                   Disabled="true" />
                                    <MudIconButton Icon="@("fa-solid fa-arrow-right")"
                                                   Size="Size.Small"
                                                   Color="Color.Default"
                                                   Disabled="true" />
                                    <MudIconButton Icon="@("fa-solid fa-arrow-up")"
                                                   Size="Size.Small"
                                                   Color="Color.Default"
                                                   OnClick="NavigateUp" />
                                    <MudIconButton Icon="@("fa-solid fa-arrows-rotate")"
                                                   Size="Size.Small"
                                                   Color="Color.Default"
                                                   OnClick="RefreshCurrentPath" />

                                    <MudTextField @bind-Value="currentPath"
                                                  Label="Path"
                                                  Variant="Variant.Outlined"
                                                  Margin="Margin.Dense"
                                                  Adornment="Adornment.End"
                                                  AdornmentIcon="@("fa-solid fa-pen")"
                                                  Class="flex-grow-1" />

                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               OnClick="NavigateToPath">
                                        Focus Folder
                                    </MudButton>
                                </MudPaper>
                            </MudItem>

                            <MudItem xs="12" md="3">
                                <MudPaper Class="pa-2" Elevation="0" Style="height: 400px; overflow-y: auto;" Outlined="true">
                                    @if (isLoadingDrives)
                                    {
                                        <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                                    }
                                    else if (drives != null)
                                    {
                                        <MudList Clickable="true" Dense="true" T="string" SelectedValue="selectedDrive" SelectedValueChanged="OnDriveSelected">
                                            @foreach (var drive in drives)
                                            {
                                                <MudListItem T="string" Value="@drive">
                                                    <div class="d-flex align-center">
                                                        <MudIcon Icon="@("fa-regular fa-hard-drive")" Size="Size.Small" Class="mr-2" />
                                                        <MudText>@drive</MudText>
                                                    </div>
                                                </MudListItem>
                                            }
                                        </MudList>
                                    }
                                </MudPaper>
                            </MudItem>

                            <MudItem xs="12" md="9">
                                <MudPaper Class="pa-2" Elevation="0" Style="height: 400px; overflow-y: auto;" Outlined="true">
                                    @if (treeItems.Any())
                                    {
                                        <MudTreeView T="string"
                                                     SelectedValue="selectedTreeItem"
                                                     SelectedValueChanged="OnSelectedValueChanged"
                                                     ExpandOnClick=true
                                                     Hover="true">
                                            @foreach (var item in treeItems)
                                            {
                                                @RenderTreeNode(item)
                                            }
                                        </MudTreeView>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">Select a drive to browse</MudText>
                                    }
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    </DialogContent>
                    <DialogActions>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Submit">Done</MudButton>
                    </DialogActions>
                </MudDialog>

                <MudDivider Class="my-2" />

                <MudText Typo="Typo.h6" Class="mb-2">Selected Folders</MudText>

                <MudDivider Class="my-2" />

                <MudText Typo="Typo.subtitle1" Color="Color.Success" Class="mb-2">
                    <strong>Included Paths (@includedPaths.Count)</strong>
                </MudText>
                <MudList T="string" Dense="true">
                    @foreach (var path in includedPaths)
                    {
                        <MudListItem T="string">
                            <div class="d-flex justify-space-between align-center">
                                <MudText>@path</MudText>
                                <MudIconButton Icon="@("fa-solid fa-trash")"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               OnClick="@(() => RemoveFromIncluded(path))" />
                            </div>
                        </MudListItem>
                    }
                </MudList>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle1" Color="Color.Error" Class="mb-2">
                    <strong>Excluded Paths (@excludedPaths.Count)</strong>
                </MudText>
                <MudList T="string" Dense="true">
                    @foreach (var path in excludedPaths)
                    {
                        <MudListItem T="string">
                            <div class="d-flex justify-space-between align-center">
                                <MudText>@path</MudText>
                                <MudIconButton Icon="@("fa-solid fa-trash")"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               OnClick="@(() => RemoveFromExcluded(path))" />
                            </div>
                        </MudListItem>
                    }
                </MudList>

                <MudDivider Class="my-6" />
                <MudText Typo="Typo.subtitle1" Color="Color.Success" Class="mb-2">
                    <strong>File Type</strong>
                </MudText>
                <MudSelect MultiSelectionTextFunc="@(new Func<List<string>, string>(GetMultiSelectionExtensionsChoice))"
                           MultiSelection="true" 
                           SelectAll="true" 
                           SelectAllText="Select all Types"
                           HelperText="Add file types"
                           @bind-SelectedValues="ExtensionOptions"
                           T="string"
                           AdornmentIcon="@("fa-solid fa-magnifying-glass")">
                    @foreach (var extension in extensions)
                    {
                        <MudSelectItem T="string" Value="@extension">@extension</MudSelectItem>
                    }
                </MudSelect>

            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    [Parameter] public HashSet<string> includedPaths { get; set; } = new();
    [Parameter] public HashSet<string> excludedPaths { get; set; } = new();
    [Parameter] public IEnumerable<string> ExtensionOptions { get; set; } = new HashSet<string>() { };

}